<?php

    session_start();                       //Відкриваємо сесію

    if((!isset($_POST['login'])) || (!isset($_POST['password'])))   // Перевіряємо чи пароль та логін встановлені для цієї сесії
    {
        header('Location: index.php');     //Повернаємо на стартову сторінку
        exit();                            //Закриваємо сесію
    }

    require_once "dbconnect.php";          //??????????????????????????????????????????

    
    $connect = @new mysqli($host, $user, $password, $database);   // Open connect!  @ - не пускає опис помилки

    if ($connect->connect_errno!=0)           //Якщо у connect  --  connect error nomber != 0
    {
        echo "Error: ".$connect->connect_errno."Ops..".$connect->connect_errno;    //Повідомляємо про помилку
    } else {

        $login = $_POST['login'];                                        //???????????????????????????
        $password = $_POST['password'];                                  //??????????????????????????

        $login = htmlentities($login, ENT_QUOTES, "UTF-8");              // від sql інєкції???????????????

        if ($rezultat = @$connect->query(                                  // від sql інєкції???????????
        sprintf("SELECT * FROM users WHERE name='%s' ",                    // від sql інєкції???????????
        mysqli_real_escape_string($connect,$login))))                      // від sql інєкції???????????
        {
            $ilu_userow = $rezultat->num_rows;           //Перевірений результат на інєкції, кількість його рядків, 
            if($ilu_userow>0)                            //Перевіряємо чи є такий користувач
            {
                $wiersz = $rezultat->fetch_assoc();     //fetch принеси  APORT

                if(password_verify($password,$wiersz['password']))    //Перевіряємо чи співпадають введений пароль на хаш парольв базі
                {

                    $_SESSION['zalogowany'] = true;             //?????????????????????????????????????

                    $_SESSION['id'] = $wiersz['id'];            //????????????????????????????????????????
                    $_SESSION['user']= $wiersz['name'];         //?????????????????????????????????????????

                    unset($_SESSION['mistake']);               //??????????????????????????????????????????
                    $rezultat->free_result();                  //?????????????????????????????????????????
                    header('Location: within.php'); //Переходимо на сторінку withi.php
                }
                else                               //Хаш паролі не співпали
                {
                    $_SESSION['mistake'] = '<span style="color:red">Не правильний логін або пароль!</span>';//Повідомляємо про помилку
                    header('Location: index.php');           //Повертаємо на головну сторінку
                }

            } else {

                $_SESSION['mistake'] = '<span style="color:red">Не правильний логін або пароль!</span>';//Повідомляємо про помилку
                header('Location: index.php'); //Повертаємо на головну сторінку

            }
        }

        $connect->close();  // Close connect.

    }






?>